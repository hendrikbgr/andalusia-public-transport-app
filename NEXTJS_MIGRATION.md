# Next.js Migration Plan

**Branch:** `next-js-migration`
**Goal:** Full migration of the vanilla JS PWA to Next.js, preserving all functionality, all pages, and the exact design language of the current app.

---

## Tech stack decisions

| Concern | Choice | Reason |
|---------|--------|--------|
| Framework | Next.js 15 (App Router) | Modern, file-based routing maps cleanly to current page-per-HTML structure |
| Language | TypeScript | Type safety for API shapes; minimal overhead |
| Styling | CSS Modules | Keeps the existing CSS (converted file-by-file); no new styling paradigm |
| i18n | Custom context (port of current cookie-based approach) | Current system is simple; avoids `next-i18next` overhead for 2-language app |
| Data fetching | Native `fetch` + SWR | SWR for live departures (auto-revalidate); plain fetch for one-shot loads |
| Maps | Leaflet (same as today) | Wrapped in `dynamic(() => import(...), { ssr: false })` |
| PWA | `next-pwa` | Handles manifest + SW generation; replaces hand-rolled `sw.js` |
| QR | `qrcode.react` | Drop-in replacement for current CDN qrcodejs |
| Package manager | npm | Minimal toolchain change |

---

## Project structure

```
transport-app/
├── app/                          # Next.js App Router
│   ├── layout.tsx                # Root layout: font, metadata, SW registration, lang cookie
│   ├── page.tsx                  # / → Home dashboard (index.html)
│   ├── stops/
│   │   └── page.tsx              # /stops → Stop selector (stops.html)
│   ├── station/
│   │   └── page.tsx              # /station?c=&s= → Live departures (station.html)
│   ├── route/
│   │   └── page.tsx              # /route?c=&l=&s=&code=&dest=&sentido= (route.html)
│   ├── map/
│   │   └── page.tsx              # /map?c=&s=&polyline= (map.html)
│   ├── planner/
│   │   └── page.tsx              # /planner (planner.html)
│   ├── journey/
│   │   └── page.tsx              # /journey (journey.html)
│   ├── timetable/
│   │   └── page.tsx              # /timetable?c=&l=&sentido= (timetable.html)
│   ├── linetimetable/
│   │   └── page.tsx              # /linetimetable (linetimetable.html)
│   └── settings/
│       └── page.tsx              # /settings (settings.html)
├── components/
│   ├── layout/
│   │   ├── AppHeader.tsx         # Sticky header: back link + title + lang toggle
│   │   └── PageShell.tsx         # Wraps main content in <main class="main-content">
│   ├── ui/
│   │   ├── Card.tsx              # .card with icon/title/sub/arrow
│   │   ├── LoadingSpinner.tsx    # .loading-spinner
│   │   ├── DefaultRegionChip.tsx # .default-region-chip
│   │   └── Confetti.tsx          # Canvas confetti (port of launchConfetti)
│   ├── home/
│   │   ├── FeatureCards.tsx
│   │   └── SavedStopsList.tsx
│   ├── stops/
│   │   ├── ConsortiumList.tsx
│   │   └── StopSearch.tsx
│   ├── station/
│   │   ├── DeparturesBoard.tsx
│   │   ├── PullToRefresh.tsx
│   │   └── QRModal.tsx
│   ├── route/
│   │   ├── RouteStopsList.tsx
│   │   └── AlertsBanner.tsx
│   ├── planner/
│   │   ├── RegionStep.tsx
│   │   ├── FormStep.tsx
│   │   └── ResultsStep.tsx
│   ├── journey/
│   │   ├── RegionStep.tsx
│   │   ├── FormStep.tsx
│   │   ├── ResultsList.tsx
│   │   └── DetailSheet.tsx
│   ├── linetimetable/
│   │   ├── RegionStep.tsx
│   │   └── TimetableGrid.tsx
│   ├── map/
│   │   └── LeafletMap.tsx        # Dynamic import (no SSR)
│   ├── pwa/
│   │   ├── InstallBanner.tsx
│   │   └── UpdateBanner.tsx
│   └── timetable/
│       └── TimetableGrid.tsx
├── lib/
│   ├── api.ts                    # All fetchJSON calls + typed API response shapes
│   ├── i18n.ts                   # getLang, setLang, t(), translations object
│   ├── cookies.ts                # getCookie, setCookie (client-only)
│   ├── savedStops.ts             # getSavedStops, addSavedStop, removeSavedStop
│   └── constants.ts             # CONSORTIUM_ICONS, API base URL
├── contexts/
│   └── LangContext.tsx           # React context: lang state + toggle, wraps root layout
├── styles/
│   ├── globals.css               # :root variables + reset (from style.css top section)
│   └── modules/                  # Per-component CSS modules (split from style.css)
│       ├── header.module.css
│       ├── card.module.css
│       ├── station.module.css
│       ├── planner.module.css
│       ├── journey.module.css
│       ├── timetable.module.css
│       ├── map.module.css
│       ├── settings.module.css
│       └── pwa.module.css
├── public/
│   ├── icons/                    # Copy from current icons/
│   └── manifest.json             # Generated by next-pwa (or keep manual)
├── next.config.js                # next-pwa config, image domains
├── tsconfig.json
└── package.json
```

---

## URL mapping (current → Next.js)

| Current URL | Next.js route | Notes |
|-------------|--------------|-------|
| `/` or `/index.html` | `/` | Home dashboard |
| `/stops.html` | `/stops` | Region → stop selector |
| `/station.html?c=X&s=Y&from=Z` | `/station?c=X&s=Y&from=Z` | Same query params |
| `/route.html?c=X&l=Y&...` | `/route?c=X&l=Y&...` | Same query params |
| `/map.html?c=X&...` | `/map?c=X&...` | Same query params |
| `/planner.html?...` | `/planner?...` | Same query params |
| `/journey.html` | `/journey` | No URL params needed |
| `/timetable.html?c=X&l=Y` | `/timetable?c=X&l=Y` | Same query params |
| `/linetimetable.html` | `/linetimetable` | No URL params needed |
| `/settings.html` | `/settings` | No URL params needed |

All existing bookmarks and external links can be handled by `next.config.js` redirects from `.html` URLs.

---

## i18n approach

Keep the current cookie-based approach but wrap it in React context:

```typescript
// contexts/LangContext.tsx
'use client';
const LangContext = createContext<{ lang: Lang; toggle: () => void }>(...);

export function LangProvider({ children }) {
  const [lang, setLangState] = useState<Lang>(() => getLang()); // reads cookie
  const toggle = () => {
    const next = lang === 'en' ? 'es' : 'en';
    setLang(next);        // writes cookie
    setLangState(next);   // triggers re-render
  };
  return <LangContext.Provider value={{ lang, toggle }}>{children}</LangContext.Provider>;
}
```

All string objects (`HOME_STRINGS`, `STRINGS`, `LTT_STRINGS`) are migrated into `lib/i18n.ts` as a single typed `STRINGS` object keyed by page/section.

---

## API layer (lib/api.ts)

Typed interfaces for every API response shape, one function per endpoint:

```typescript
const API = 'https://api.ctan.es/v1/Consorcios';

export async function getConsorcios(): Promise<Consorcio[]>
export async function getParadas(cId: string): Promise<Parada[]>
export async function getParada(cId: string, sId: string): Promise<ParadaDetail>
export async function getLinea(cId: string, lId: string): Promise<Linea>
export async function getLineaParadas(cId: string, lId: string): Promise<Parada[]>
export async function getHorarios(cId: string, from: string, to: string): Promise<Horarios>
// ... etc
```

SWR used only for live departures (station page) to get auto-refresh every 30s without a manual timer.

---

## PWA / Service Worker

Use `next-pwa` (`@ducanh2912/next-pwa` — maintained fork):
- Generates `sw.js` at build time
- Precaches all Next.js build assets (replaces hand-rolled SHELL array)
- Runtime caching: API calls bypass cache (NetworkOnly for `api.ctan.es`)
- App update detection: SW `waiting` → `controllerchange` flow stays the same, moved into `UpdateBanner` component using `useEffect`

---

## Key technical notes

### Leaflet (map page)
Must be a dynamic import with `ssr: false` since Leaflet accesses `window`:
```typescript
const LeafletMap = dynamic(() => import('@/components/map/LeafletMap'), { ssr: false });
```

### sessionStorage (polylines)
`mapPolyline`, `journeyPolylines`, `showUpdateConfetti` — all stay as sessionStorage.
Accessed in `useEffect` (client-only), same as today.

### Pull-to-refresh (station page)
Vanilla touch event logic migrated into a `usePullToRefresh` hook.

### Back button / `from=` param
`useSearchParams()` replaces `new URLSearchParams(location.search)`. The `from` param encodes a path (not a full `.html` URL anymore), e.g. `from=%2Fplanner%3Fc%3D4%26fromN%3D201`.

### Confetti
Moved to `<Confetti />` component that reads `sessionStorage.showUpdateConfetti` on mount.

---

## Migration phases

### Phase 1 — Scaffolding
- [ ] `npx create-next-app@latest` inside repo on this branch
- [ ] Install dependencies: `swr`, `@ducanh2912/next-pwa`, `qrcode.react`, `leaflet`, `@types/leaflet`
- [ ] Set up `tsconfig.json`, `next.config.js` (pwa config, `.html` redirects)
- [ ] Port CSS: `globals.css` (`:root` variables + reset), split `style.css` into CSS modules
- [ ] Create `LangContext` + `lib/i18n.ts` (all translations)
- [ ] Create `lib/api.ts` (all typed API functions)
- [ ] Create `lib/cookies.ts`, `lib/savedStops.ts`, `lib/constants.ts`
- [ ] Create root `layout.tsx` (LangProvider, metadata, SW registration)
- [ ] Create shared components: `AppHeader`, `PageShell`, `Card`, `LoadingSpinner`, `DefaultRegionChip`

### Phase 2 — Core pages (no external deps)
- [ ] Home page (`/`) — feature cards, saved stops, PWA/update banners, confetti
- [ ] Stops page (`/stops`) — consortium list, stop search, saved stops
- [ ] Settings page (`/settings`) — language, default date, default region, saved stops management

### Phase 3 — Departure-related pages
- [ ] Station page (`/station`) — live departures board, pull-to-refresh, save stop, QR modal
- [ ] Route page (`/route`) — stops list, direction tabs, alerts banner, polyline button
- [ ] Timetable page (`/timetable`) — grid, direction tabs, frequency tabs

### Phase 4 — Planning pages
- [ ] Planner page (`/planner`) — region → form → results flow, default-region chip
- [ ] Journey page (`/journey`) — same multi-step flow, detail sheet, out-of-network search
- [ ] Line Timetable page (`/linetimetable`) — region → line search → timetable grid

### Phase 5 — Map page
- [ ] Map page (`/map`) — Leaflet dynamic import, polyline overlay, region selector, location dot

### Phase 6 — PWA & polish
- [ ] Configure `next-pwa` (precache, runtime caching rules)
- [ ] SW update detection in `UpdateBanner` component
- [ ] PWA install banner
- [ ] `manifest.json` + icons
- [ ] `.html` redirect rules in `next.config.js`
- [ ] Test all deep links still work

### Phase 7 — Tests
- [ ] Update Python/Playwright tests to use new URL scheme (no `.html` extension)
- [ ] Verify all query params work identically

---

## What stays identical

- All CSS variable values (copied verbatim into `globals.css`)
- All colors, spacing, border-radius, shadows
- All emoji icons for consortiums and UI
- The exact card/list/step UI patterns
- The API base URL and all endpoint paths
- The cookie names and formats (`lang`, `defaultRegion`, `savedStops`, etc.)
- The sessionStorage keys
- The consortium icons mapping
- The language strings (translated verbatim)

## What improves

- No more `?v=N` manual cache busting — Next.js build hashes assets automatically
- No more bump-version.yml workflow needed for assets
- TypeScript type safety on all API responses
- SWR automatic refresh on station page (no manual `setInterval`)
- Proper code splitting per page (currently all JS is loaded per page anyway, this maintains that)
- PWA managed by next-pwa (less hand-rolled SW logic)
