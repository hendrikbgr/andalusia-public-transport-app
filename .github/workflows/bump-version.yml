name: Bump App Version

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  bump:
    name: Bump version in index.html and sw.js
    runs-on: ubuntu-latest
    # Skip if this push was itself the version bump commit (avoid infinite loop)
    if: "!startsWith(github.event.head_commit.message, 'chore: bump version')"

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2

      - name: Read current version and increment
        id: version
        run: |
          CURRENT=$(grep -oP '(?<=home-version">v)\d+' index.html)
          NEW=$((CURRENT + 1))
          echo "old=v${CURRENT}" >> "$GITHUB_OUTPUT"
          echo "new=v${NEW}"     >> "$GITHUB_OUTPUT"

      - name: Apply bumps
        run: |
          OLD="${{ steps.version.outputs.old }}"
          NEW="${{ steps.version.outputs.new }}"

          # 1. Bump display badge in index.html
          sed -i "s|home-version\">${OLD}<|home-version\">${NEW}<|" index.html

          # 2. Bump service worker cache name  e.g. ctan-shell-v11 â†’ ctan-shell-v12
          sed -i "s|ctan-shell-${OLD}|ctan-shell-${NEW}|" sw.js

          # 3. For every src/js/*.js or src/style.css changed in this commit,
          #    bump the ?v=N query string in every HTML file that references it.
          CHANGED=$(git diff --name-only HEAD~1 HEAD \
            | grep -E '^src/(js/[^/]+\.js|style\.css)$' || true)

          for ASSET in $CHANGED; do
            BASENAME=$(basename "$ASSET")
            echo "Bumping ?v= for $BASENAME..."
            python3 - "$BASENAME" *.html <<'PYEOF'
          import re, sys
          basename = sys.argv[1]
          html_files = sys.argv[2:]
          pattern = re.compile(r'(' + re.escape(basename) + r'\?v=)(\d+)')
          for path in html_files:
              text = open(path).read()
              new_text = pattern.sub(lambda m: m.group(1) + str(int(m.group(2)) + 1), text)
              if new_text != text:
                  open(path, 'w').write(new_text)
                  print(f"  updated {path}")
          PYEOF
          done

      - name: Commit and push
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add *.html sw.js
          git diff --cached --quiet && echo "Nothing to commit" && exit 0
          git commit -m "chore: bump version to ${{ steps.version.outputs.new }}"
          git push
